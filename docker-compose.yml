version: "3.9"

services:
  api:
    build: ./api
    container_name: api 
    ports:
      - "3000:3000"
    environment:
      - PORT=3000
      - NODE_ENV=develop
      - DB_USER=sa
      - DB_PASSWORD=YourStrong!Passw0rd
      - DB_HOST=db
      - DB_NAME=challenge
      - S3_AWS_REGION=us-east-1
      - S3_AWS_ACCESS_KEY_ID=test
      - S3_AWS_SECRET_ACCESS_KEY=test
      - S3_BUCKET=jobs
      - SQS_QUEUE_URL=http://sqs.us-east-1.localstack:4566/000000000000/jobs-queue
      - SQS_ENDPOINT=http://localstack:4566/000000000000/jobs-queue
      - AWS_ACCESS_KEY_ID=test
      - AWS_SECRET_ACCESS_KEY=test
      - AWS_DEFAULT_REGION=us-east-1
    depends_on:
      localstack:
        condition: service_started
      db:
        condition: service_healthy

  worker:
    build: ./worker
    container_name: worker
    environment:
      - PORT=3000
      - NODE_ENV=develop
      - DB_USER=sa
      - DB_PASSWORD=YourStrong!Passw0rd
      - DB_HOST=db
      - DB_NAME=challenge
      - S3_AWS_REGION=us-east-1
      - S3_AWS_ACCESS_KEY_ID=test
      - S3_AWS_SECRET_ACCESS_KEY=test
      - S3_BUCKET=jobs
      - SQS_QUEUE_URL=http://sqs.us-east-1.localstack:4566/000000000000/jobs-queue
      - SQS_ENDPOINT=http://localstack:4566/000000000000/jobs-queue
      - AWS_ACCESS_KEY_ID=test
      - AWS_SECRET_ACCESS_KEY=test
      - AWS_DEFAULT_REGION=us-east-1
    depends_on:
      localstack:
        condition: service_started
      db:
        condition: service_healthy
    deploy:
      replicas: 1  # intenci√≥n de escala
      resources:
        limits:
          cpus: "1"
          memory: 1G
        reservations:
          cpus: "0.5"
          memory: 512M

  localstack:
    image: localstack/localstack
    container_name: localstack
    ports:
      - "4566:4566"
    environment:
      - SERVICES=s3,sqs
      - AWS_DEFAULT_REGION=us-east-1
#      - LOCALSTACK_HOST=localhost
      - AWS_ACCESS_KEY_ID=test
      - AWS_SECRET_ACCESS_KEY=test
    volumes:
      - ./localstack/init/ready.d:/etc/localstack/init/ready.d:ro

  db:
    image: mcr.microsoft.com/mssql/server:2022-latest
    container_name: db
    environment:
      ACCEPT_EULA: "Y"
      MSSQL_SA_PASSWORD: "YourStrong!Passw0rd"
    ports:
      - "1433:1433"
    healthcheck:
      test: ["CMD-SHELL", "timeout 3 bash -c '</dev/tcp/127.0.0.1/1433' || exit 1"]
      interval: 5s
      timeout: 5s
      retries: 10
      start_period: 15s
  sql-init:
    image: mcr.microsoft.com/mssql-tools
    container_name: sql-init
    depends_on:
      db:
        condition: service_healthy
    volumes:
      - ./sql/schema.sql:/init.sql
    command: >
      bash -c "
      echo 'waiting sql server...' &&
      /opt/mssql-tools/bin/sqlcmd -S db -U sa -P 'YourStrong!Passw0rd' -i /init.sql
      "
    restart: "no"
